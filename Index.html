<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>G4G Data Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <?!= include('Styles'); ?>
</head>
<body>

  <div id="login-view" style="height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);">
    <div class="card" style="width: 100%; max-width: 400px; text-align: center; padding: 40px;">
      <h1 style="color: #1a73e8; margin-bottom: 24px;">G4G Data Hub</h1>
      <form id="login-form">
        <div class="form-group">
          <input type="text" id="login-username" class="form-input" placeholder="Username" required style="padding: 12px;">
        </div>
        <div class="form-group">
          <input type="password" id="login-password" class="form-input" placeholder="Password" required style="padding: 12px;">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;" id="btn-login">Login</button>
        <p id="login-error" class="text-danger mt-2" style="display: none;"></p>
      </form>
    </div>
  </div>

  <div id="app-shell" style="display: none;">
    <header class="app-header">
      <div class="container">
        <h1 class="app-title">G4G Data Hub</h1>
        <div class="user-info">
          <span class="user-role" id="header-user"></span>
          <span class="user-site" id="header-site"></span>
          <button class="btn btn-link" onclick="logout()" style="color: white; text-decoration: underline;">Logout</button>
        </div>
      </div>
    </header>

    <nav class="app-nav">
      <div class="container">
        <button class="nav-btn active" data-page="dashboard" onclick="nav('dashboard')">Dashboard</button>
        <button class="nav-btn" data-page="participants" onclick="nav('participants')">Participants</button>
        <button class="nav-btn" id="nav-admin" data-page="admin" onclick="nav('admin')" style="display: none;">Admin Portal</button>
      </div>
    </nav>

    <main class="app-main">
      <div class="container" id="content-container">
        <div class="loading">Loading...</div>
      </div>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const STATE = { token: null, user: null, refreshInterval: null, currentFilters: {} };

    // ==========================================
    // AUTHENTICATION & NAVIGATION
    // ==========================================
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-login');
      const err = document.getElementById('login-error');
      btn.disabled = true; btn.textContent = 'Verifying...'; err.style.display = 'none';

      google.script.run
        .withSuccessHandler(function(res) {
          if (res.success) {
            STATE.token = res.token;
            STATE.user = res.user;
            initAppUI();
          }
        })
        .withFailureHandler(function(e) {
          err.textContent = e.message; err.style.display = 'block';
          btn.disabled = false; btn.textContent = 'Login';
        })
        .login(document.getElementById('login-username').value, document.getElementById('login-password').value);
    });

    function initAppUI() {
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('app-shell').style.display = 'block';
      document.getElementById('header-user').textContent = STATE.user.username + ' (' + STATE.user.role + ')';
      document.getElementById('header-site').textContent = STATE.user.site_scope;

      if (STATE.user.can_enroll || STATE.user.can_admin) {
        document.getElementById('nav-admin').style.display = 'inline-block';
      }
      
      // Start Real-time refresh
      if (STATE.refreshInterval) clearInterval(STATE.refreshInterval);
      STATE.refreshInterval = setInterval(refreshCurrentView, 30000); // 30 seconds

      nav('dashboard');
    }

    function logout() { STATE.token = null; STATE.user = null; location.reload(); }

    function nav(page, params) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector(`.nav-btn[data-page="${page}"]`);
      if(activeBtn) activeBtn.classList.add('active');

      const container = document.getElementById('content-container');
      container.innerHTML = '<div class="loading">Loading...</div>';

      const run = google.script.run.withSuccessHandler(html => {
        container.innerHTML = html;
        if(page === 'dashboard') initDashboard();
        if(page === 'participants') initParticipants();
        if(page === 'participant-detail') initDetail(params); // You need to clean ParticipantDetail.html too!
        if(page === 'admin') appInitAdmin();
      }).withFailureHandler(handleError);

      if (page === 'dashboard') run.include('Dashboard');
      if (page === 'participants') run.include('Participants');
      if (page === 'participant-detail') run.include('ParticipantDetail');
      if (page === 'admin') run.include('Admin');
    }

    function refreshCurrentView() {
      const active = document.querySelector('.nav-btn.active');
      if(!active) return;
      const page = active.getAttribute('data-page');
      if (page === 'dashboard') loadDashboardData();
      if (page === 'participants') loadParticipantsList();
    }

    // ==========================================
    // DASHBOARD LOGIC
    // ==========================================
    function initDashboard() {
      loadDashboardData();
    }

    function loadDashboardData() {
      // Collect filters if elements exist (might be called by refresh)
      const siteEl = document.getElementById('filter-site');
      if (siteEl) {
        STATE.currentFilters = {
          site: document.getElementById('filter-site').value,
          cohort: document.getElementById('filter-cohort').value,
          status: document.getElementById('filter-status').value
        };
      }
      
      google.script.run.withSuccessHandler(renderDashboard).withFailureHandler(handleError)
        .getDashboardStats(STATE.token, STATE.currentFilters);
    }

    function renderDashboard(data) {
      // 1. Populate Dropdowns (only if not already populated/changed)
      const siteFilter = document.getElementById('filter-site');
      if (siteFilter && siteFilter.options.length <= 1) {
         if (data.user.site_scope === 'ALL') {
            siteFilter.innerHTML = '<option value="ALL">All Sites</option><option value="UGA">UGA</option><option value="MIZZOU">MIZZOU</option>';
         } else {
            siteFilter.innerHTML = '<option value="' + data.user.site_scope + '">' + data.user.site_scope + '</option>';
            siteFilter.disabled = true;
         }
         siteFilter.value = STATE.currentFilters.site || (data.user.site_scope === 'ALL' ? 'ALL' : data.user.site_scope);
      }

      const cohortFilter = document.getElementById('filter-cohort');
      if (cohortFilter && cohortFilter.options.length <= 1) {
         let opts = '<option value="">All Cohorts</option>';
         data.cohorts.forEach(c => opts += `<option value="${c}">${c}</option>`);
         cohortFilter.innerHTML = opts;
         if(STATE.currentFilters.cohort) cohortFilter.value = STATE.currentFilters.cohort;
      }

      // 2. Render Stats
      const stats = data.stats;
      const grid = document.getElementById('stats-grid');
      if(grid) {
        grid.innerHTML = `
          <div class="stat-card"><div class="stat-value">${stats.total_participants}</div><div class="stat-label">Total Participants</div></div>
          <div class="stat-card"><div class="stat-value">${stats.fully_complete}</div><div class="stat-label">Fully Complete</div></div>
          <div class="stat-card"><div class="stat-value">${stats.fully_complete_percent}%</div><div class="stat-label">% Complete</div></div>
          <div class="stat-card"><div class="stat-value">${stats.avg_completion}%</div><div class="stat-label">Avg Progress</div></div>
          <div class="stat-card"><div class="stat-value">${stats.total_missing}</div><div class="stat-label">Missing Items</div></div>
        `;
      }

      // 3. Render Table
      const tbody = document.getElementById('participants-tbody');
      if(tbody) {
        if (data.participants.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No participants found</td></tr>';
        } else {
          tbody.innerHTML = data.participants.map(p => {
            const statusClass = p.status === 'Active' ? 'badge-success' : p.status === 'Withdrawn' ? 'badge-danger' : 'badge-info';
            return `
              <tr>
                <td><strong>${p.participant_id}</strong></td>
                <td>${p.site}</td>
                <td>${p.cohort || '-'}</td>
                <td><span class="badge ${statusClass}">${p.status}</span></td>
                <td><div class="progress"><div class="progress-bar" style="width: ${p.completion_percent}%"></div></div> ${p.completion_percent}%</td>
                <td><span class="badge ${p.missing_count > 0 ? 'badge-warning' : 'badge-success'}">${p.missing_count}</span></td>
                <td>${formatDateShort(p.last_updated)}</td>
                <td><button class="btn btn-primary btn-small" onclick="nav('participant-detail', {participantId: '${p.participant_id}'})">Open</button></td>
              </tr>`;
          }).join('');
        }
      }
    }

    function exportParticipantsData() {
        google.script.run.withSuccessHandler(csv => {
            downloadCSV(csv, 'dashboard_export.csv');
        }).exportParticipants(STATE.currentFilters);
    }

    // ==========================================
    // PARTICIPANTS LIST LOGIC
    // ==========================================
    function initParticipants() { loadParticipantsList(); }

    function loadParticipantsList() {
      const filters = {
        search: document.getElementById('search-participant') ? document.getElementById('search-participant').value : '',
        site: document.getElementById('filter-site-participants') ? document.getElementById('filter-site-participants').value : 'ALL',
        status: document.getElementById('filter-status-participants') ? document.getElementById('filter-status-participants').value : ''
      };
      
      // Spinner
      const tbody = document.getElementById('participants-list-tbody');
      if(tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';

      google.script.run.withSuccessHandler(renderParticipantsList).withFailureHandler(handleError)
        .getDashboardStats(STATE.token, filters);
    }

    function renderParticipantsList(data) {
      // Sync Dropdowns (similar logic to dashboard)
      const siteFilter = document.getElementById('filter-site-participants');
      if(siteFilter && siteFilter.options.length <= 1) {
         if (data.user.site_scope === 'ALL') siteFilter.innerHTML = '<option value="ALL">All Sites</option><option value="UGA">UGA</option><option value="MIZZOU">MIZZOU</option>';
         else { siteFilter.innerHTML = `<option value="${data.user.site_scope}">${data.user.site_scope}</option>`; siteFilter.disabled = true; }
      }

      const tbody = document.getElementById('participants-list-tbody');
      if(tbody) {
         if(data.participants.length === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center">No participants found</td></tr>';
         else {
            tbody.innerHTML = data.participants.map(p => `
              <tr>
                <td><strong>${p.participant_id}</strong></td>
                <td>${p.site}</td>
                <td>${p.cohort || '-'}</td>
                <td>${p.status}</td>
                <td>${formatDateShort(p.enroll_date)}</td>
                <td>${p.completion_percent}%</td>
                <td>${p.missing_count > 0 ? `<a href="#" onclick="showMissingItems('${p.participant_id}')" class="text-danger">${p.missing_count} missing</a>` : 'Complete'}</td>
                <td><button class="btn btn-primary btn-small" onclick="nav('participant-detail', {participantId: '${p.participant_id}'})">Open</button></td>
              </tr>
            `).join('');
            document.getElementById('participants-count').textContent = `Showing ${data.participants.length} participants`;
         }
      }
    }

    function showMissingItems(id) {
       google.script.run.withSuccessHandler(detail => {
          const missing = detail.completions.filter(c => !c.is_complete);
          document.getElementById('detail-participant-id-missing').textContent = id;
          document.getElementById('missing-items-list').innerHTML = `<ol>${missing.map(m => `<li>${m.instrument_name}</li>`).join('')}</ol>`;
          document.getElementById('missing-items-detail').style.display = 'block';
       }).getParticipantDetail(STATE.token, id);
    }

    function exportParticipantsList() {
        const filters = {
            search: document.getElementById('search-participant').value,
            site: document.getElementById('filter-site-participants').value,
            status: document.getElementById('filter-status-participants').value
        };
        google.script.run.withSuccessHandler(csv => downloadCSV(csv, 'participants_list.csv')).exportParticipants(filters);
    }

    // ==========================================
    // ADMIN LOGIC (From previous fix)
    // ==========================================
    function appInitAdmin() {
      const user = STATE.user;
      if (user.can_admin) { document.getElementById('tab-users').style.display = 'inline-block'; appLoadUsers(); }
      else { document.getElementById('tab-users').style.display = 'none'; }
      
      const siteSel = document.getElementById('enroll-site');
      if (siteSel) {
        if (user.site_scope !== 'ALL') { siteSel.value = user.site_scope; siteSel.disabled = true; } 
        else { siteSel.disabled = false; }
      }
    }
    function appShowAdminSection(id) {
      document.querySelectorAll('.admin-section').forEach(d => d.style.display = 'none');
      document.getElementById('section-' + id).style.display = 'block';
    }
    function appSubmitEnroll(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-enroll');
      btn.disabled = true; btn.textContent = "Enrolling...";
      const data = {
        site: document.getElementById('enroll-site').value,
        cohort: document.getElementById('enroll-cohort').value,
        participant_name: document.getElementById('enroll-name').value,
        notes: document.getElementById('enroll-notes').value
      };
      if (!data.site) return showToast('Select site', 'error');
      google.script.run.withSuccessHandler(() => {
          showToast('Enrolled!', 'success'); document.getElementById('enroll-form').reset();
          if (STATE.user.site_scope !== 'ALL') document.getElementById('enroll-site').value = STATE.user.site_scope;
          btn.disabled = false; btn.textContent = "Enroll";
      }).withFailureHandler(err => { handleError(err); btn.disabled = false; btn.textContent = "Enroll"; }).createParticipant(STATE.token, data);
    }
    function appLoadUsers() {
      google.script.run.withSuccessHandler(users => {
        document.getElementById('users-tbody').innerHTML = users.map(u => `
          <tr><td>${u.username}</td><td>${u.role}</td><td>${u.site_scope}</td><td>${u.active}</td>
          <td><button class="btn btn-link" onclick='appEditUser(${JSON.stringify(u)})'>Edit</button></td></tr>
        `).join('');
      }).getUsers(STATE.token);
    }
    function appOpenUserModal() { document.getElementById('user-modal').classList.add('show'); }
    function appCloseUserModal() { document.getElementById('user-modal').classList.remove('show'); }
    function appEditUser(u) {
       document.getElementById('user-modal').classList.add('show');
       document.getElementById('form-user-name').value = u.username;
       document.getElementById('form-user-role').value = u.role;
       document.getElementById('form-user-site').value = u.site_scope;
    }
    function appSubmitUser() {
        const data = {
            username: document.getElementById('form-user-name').value,
            password: document.getElementById('form-user-pass').value,
            role: document.getElementById('form-user-role').value,
            site_scope: document.getElementById('form-user-site').value,
            active: document.getElementById('form-user-active').checked
        };
        google.script.run.withSuccessHandler(() => { appCloseUserModal(); appLoadUsers(); }).saveUser(STATE.token, data);
    }

    // ==========================================
    // UTILS
    // ==========================================
    function handleError(e) { console.error(e); showToast(e.message || 'Error', 'error'); }
    function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show '+(type||'info'); setTimeout(()=>t.className='toast',3000); }
    function formatDateShort(d) { if(!d) return ''; const date = new Date(d); return isNaN(date) ? '' : date.toLocaleDateString(); }
    function downloadCSV(csv, name) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click();
    }
    function initDetail(params) { /* Logic for ParticipantDetail would go here if migrated */ }
  </script>
</body>
</html>