<div class="admin-page">
  <div style="display: flex; gap: 16px; margin-bottom: 20px;">
    <button class="btn btn-secondary" onclick="showSection('enroll')" id="tab-enroll">Enroll New Participant</button>
    <button class="btn btn-secondary" onclick="showSection('users')" id="tab-users">User Management</button>
  </div>

  <div id="section-enroll" class="admin-section">
    <div class="card" style="max-width: 800px;">
      <h2 class="card-title">Enroll New Participant</h2>
      <form id="enroll-form">
        <div class="form-group">
          <label class="form-label">Site</label>
          <select id="enroll-site" class="form-select" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Cohort</label>
          <input type="text" id="enroll-cohort" class="form-input" placeholder="e.g. Fall 2024" required>
        </div>
        <div class="form-group">
          <label class="form-label">Full Name (Required)</label>
          <input type="text" id="enroll-name" class="form-input" placeholder="First Last" required>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea id="enroll-notes" class="form-textarea"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="btn-enroll">Enroll</button>
      </form>
    </div>
  </div>

  <div id="section-users" class="admin-section" style="display: none;">
    <div class="card">
      <h2 class="card-title">User Management</h2>
      <button class="btn btn-primary mb-2" onclick="openUserModal()">Add User</button>
      <div class="table-container">
        <table id="users-table">
          <thead><tr><th>Username</th><th>Role</th><th>Site</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="user-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3 class="modal-title">Save User</h3></div>
    <div class="modal-body">
      <div class="form-group"><label>Username</label><input type="text" id="form-user-name" class="form-input"></div>
      <div class="form-group"><label>Password</label><input type="text" id="form-user-pass" class="form-input"></div>
      <div class="form-group"><label>Role</label>
        <select id="form-user-role" class="form-select">
          <option value="Facilitator">Facilitator</option>
          <option value="SiteLead">Site Lead</option>
          <option value="ProjectLead">Project Lead</option>
          <option value="Admin">Admin</option>
          <option value="Viewer">Viewer</option>
        </select>
      </div>
      <div class="form-group"><label>Site</label>
        <select id="form-user-site" class="form-select">
          <option value="UGA">UGA</option>
          <option value="MIZZOU">MIZZOU</option>
          <option value="ALL">ALL (Admins only)</option>
        </select>
      </div>
      <div class="form-group"><label><input type="checkbox" id="form-user-active" checked> Active</label></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitUser()">Save</button>
    </div>
  </div>
</div>

<script>
function initAdmin() {
  const user = STATE.user;
  
  // Show/Hide Tabs based on Role
  if (!user.can_admin) {
    document.getElementById('tab-users').style.display = 'none';
  }
  
  // Setup Enroll Form
  const siteSel = document.getElementById('enroll-site');
  if (user.site_scope === 'ALL') {
    siteSel.innerHTML = '<option value="UGA">UGA</option><option value="MIZZOU">MIZZOU</option>';
  } else {
    siteSel.innerHTML = '<option value="'+user.site_scope+'">'+user.site_scope+'</option>';
  }
  
  document.getElementById('enroll-form').addEventListener('submit', function(e) {
    e.preventDefault();
    submitEnroll();
  });

  // Load Users if Admin
  if (user.can_admin) loadUsers();
}

function showSection(id) {
  document.querySelectorAll('.admin-section').forEach(d => d.style.display = 'none');
  document.getElementById('section-' + id).style.display = 'block';
}

function submitEnroll() {
  const btn = document.getElementById('btn-enroll');
  btn.disabled = true;
  const data = {
    site: document.getElementById('enroll-site').value,
    cohort: document.getElementById('enroll-cohort').value,
    participant_name: document.getElementById('enroll-name').value,
    notes: document.getElementById('enroll-notes').value
  };
  
  google.script.run
    .withSuccessHandler(() => {
      showToast('Enrolled!', 'success');
      document.getElementById('enroll-form').reset();
      btn.disabled = false;
    })
    .withFailureHandler(err => { handleError(err); btn.disabled = false; })
    .createParticipant(STATE.token, data);
}

function loadUsers() {
  google.script.run.withSuccessHandler(renderUsers).getUsers(STATE.token);
}

function renderUsers(users) {
  const html = users.map(u => `
    <tr>
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>${u.site_scope}</td>
      <td>${u.active ? 'Active' : 'Inactive'}</td>
      <td><button class="btn btn-link" onclick='editUser(${JSON.stringify(u)})'>Edit</button></td>
    </tr>
  `).join('');
  document.getElementById('users-tbody').innerHTML = html;
}

function openUserModal() { document.getElementById('user-modal').classList.add('show'); }
function closeModal() { document.getElementById('user-modal').classList.remove('show'); }

function submitUser() {
  const data = {
    username: document.getElementById('form-user-name').value,
    password: document.getElementById('form-user-pass').value,
    role: document.getElementById('form-user-role').value,
    site_scope: document.getElementById('form-user-site').value,
    active: document.getElementById('form-user-active').checked
  };
  google.script.run.withSuccessHandler(() => {
    closeModal(); loadUsers(); showToast('User Saved');
  }).saveUser(STATE.token, data);
}
</script>